- hosts: all
  tasks:
    - name: Fetch artifact
      get_url:
        url: "{{ item.url }}"
        dest: "{{ zuul.project.src_dir }}/{{ image_operating_system }}-kube-{{ kube_tag }}.qcow2"
      register: fetch_artifact
      loop: "{{ zuul.artifacts }}"
      when:
        - item.name is defined
        - item.name == "{{ image_operating_system }}-kube-{{ kube_tag }}.qcow2"

    - name: Install DevStack
      ansible.builtin.include_role:
        name: orchestrate-devstack

    - name: Install kubectl CLI
      ansible.builtin.shell: ./hack/setup-kubectl.sh
      args:
        chdir: "{{ zuul.project.src_dir }}"

    - name: Install Helm
      ansible.builtin.shell: ./hack/setup-helm.sh
      args:
        chdir: "{{ zuul.project.src_dir }}"

    - name: Install Docker
      ansible.builtin.shell: ./hack/setup-docker.sh
      args:
        chdir: "{{ zuul.project.src_dir }}"

    - name: Install Kind
      ansible.builtin.shell: ./hack/setup-kind.sh
      args:
        chdir: "{{ zuul.project.src_dir }}"

    - name: Install CAPI/CAPO
      ansible.builtin.shell: ./hack/setup-capo.sh
      args:
        chdir: "{{ zuul.project.src_dir }}"

    - name: Upgrade pip to the latest version
      ansible.builtin.pip:
        name: pip
        state: latest

    - name: Install "magnum-cluster-api"
      ansible.builtin.pip:
        name: "."
        editable: true
        extra_args: --constraint /opt/stack/requirements/upper-constraints.txt
        virtualenv: /opt/stack/data/venv
        chdir: "{{ zuul.project.src_dir }}"

    - name: Restart Magnum services
      become: true
      ansible.builtin.service:
        name: "{{ item }}"
        state: restarted
      loop:
        - devstack@magnum-api
        - devstack@magnum-cond

    - ansible.builtin.shell: "./hack/run-integration-tests.sh"
      args:
        chdir: "{{ zuul.project.src_dir }}"
      environment:
        IMAGE_NAME: "{{ image_url.split('/')[-1].split('.')[0] }}"
        KUBE_TAG: "{{ kube_tag }}"
        NETWORK_DRIVER: "{{ network_driver }}"
        NODE_COUNT: 2
        OS_CLOUD: devstack

    - name: Copy Sonobuoy results to output folder
      copy:
        src: "{{ zuul.project.src_dir }}/sonobuoy-results.tar.gz"
        dest: "{{ zuul_output_dir }}/artifacts/sonobuoy-results.tar.gz"
        remote_src: true
