- hosts: all
  tasks:
    - name: Copy individual Hydrophone result files
      ansible.builtin.copy:
        src: "{{ zuul.project.src_dir }}/hydrophone-results/{{ item }}"
        dest: "{{ zuul_output_dir }}/artifacts/{{ item }}"
        remote_src: true
      ignore_errors: true
      loop:
        - e2e.log
        - junit_01.xml

    - name: Copy Hydrophone results tarball to output folder
      ansible.builtin.copy:
        src: "{{ zuul.project.src_dir }}/hydrophone-results.tar.gz"
        dest: "{{ zuul_output_dir }}/artifacts/hydrophone-results.tar.gz"
        remote_src: true
      ignore_errors: true

    - name: Return built artifacts to Zuul
      zuul_return:
        data:
          zuul:
            artifacts:
              - name: "Conformance Results"
                url: "artifacts/hydrophone-results.tar.gz"
                metadata:
                  type: tarball
              - name: "e2e.log"
                url: "artifacts/e2e.log"
              - name: "junit_01.xml"
                url: "artifacts/junit_01.xml"

    - name: Gather all pod logs from KinD
      become: true
      ignore_errors: true
      block:
        - name: Get the Docker volume ID
          ansible.builtin.command: docker volume ls -q
          register: volume_id

        - name: Copy all of the pod logs
          ansible.builtin.copy:
            src: "/var/lib/docker/volumes/{{ volume_id.stdout_lines[0] }}/_data/log/pods"
            dest: "{{ zuul_output_dir }}/logs"
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            remote_src: true
